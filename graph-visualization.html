<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Knowledge Graph Visualization</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üï∏Ô∏è</text></svg>">
    
    <!-- React and ReactDOM from CDN (Production builds) -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <!-- D3.js for graph visualization -->
    <script src="https://d3js.org/d3.v7.min.js"></script>
    
    <!-- Lucide React for icons -->
    <script src="https://unpkg.com/lucide-react@latest/dist/umd/lucide-react.js"></script>
    
    <!-- Custom CSS -->
    <style>
        body { 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            margin: 0; 
            padding: 0; 
            background-color: #2C2C2C; 
            color: #E4E4E4; 
            overflow: hidden;
        }
        .container { 
            height: 100vh; 
            display: flex; 
            flex-direction: column; 
        }
        .header { 
            padding: 1rem; 
            background-color: #3A3A3A; 
            border-bottom: 1px solid #4A4A4A; 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
        }
        .title { 
            font-size: 1.5rem; 
            font-weight: 600; 
            color: #E4E4E4; 
            margin: 0; 
        }
        .status { 
            color: #B8B8B8; 
            font-size: 0.875rem; 
        }
        .graph-container { 
            flex: 1; 
            position: relative; 
            background-color: #2C2C2C; 
        }
        .loading { 
            display: flex; 
            justify-content: center; 
            align-items: center; 
            height: 100%; 
            color: #B8B8B8; 
        }
        .error { 
            display: flex; 
            justify-content: center; 
            align-items: center; 
            height: 100%; 
            color: #FF6B6B; 
            flex-direction: column; 
        }
        .button { 
            padding: 0.5rem 1rem; 
            border-radius: 0.25rem; 
            border: none; 
            background-color: #B39CD0; 
            color: #2C2C2C; 
            font-weight: 500; 
            cursor: pointer; 
            transition: opacity 0.2s; 
        }
        .button:hover { 
            opacity: 0.8; 
        }
        .button:disabled { 
            opacity: 0.5; 
            cursor: not-allowed; 
        }
    </style>
</head>
<body>
    <div id="root"></div>
    
    <!-- Main React App -->
    <script>
        const { useState, useEffect, useRef, useCallback } = React;
        const { X } = LucideReact;

        // Graph Configuration
        const GRAPH_CONFIG = {
            colors: {
                background: '#2C2C2C',
                foreground: '#E4E4E4',
                border: '#4A4A4A',
                accent: '#3A3A3A',
                muted: '#B8B8B8',
                people: '#B39CD0',
                events: '#FFC1CC',
                places: '#A8DADC',
                linkDefault: '#B8B8B8',
                linkHighlight: '#E4E4E4',
                animatedParticle: '#B39CD0'
            },
            nodes: {
                baseRadius: 28,
                glowRadius: 32,
                hoverGlowRadius: 40,
                innerRadius: 22,
                strokeWidth: 2,
                selectedStrokeWidth: 3,
                fontSize: 11,
                fontWeight: '600'
            },
            links: {
                defaultWidth: 1.5,
                highlightWidth: 3,
                defaultOpacity: 0.6,
                highlightOpacity: 0.9,
                dimmedOpacity: 0.2,
                animationDuration: '3s',
                particleRadius: 2.5,
                curvature: 0.3
            }
        };

        // Main Graph Visualization Component
        function GraphVisualization() {
            const svgRef = useRef(null);
            const [graphData, setGraphData] = useState(null);
            const [loading, setLoading] = useState(true);
            const [error, setError] = useState(null);
            const [selectedNode, setSelectedNode] = useState(null);

            useEffect(() => {
                // Get graph data from parent window
                if (window.opener && window.opener.currentGraphData) {
                    setGraphData(window.opener.currentGraphData);
                    setLoading(false);
                } else {
                    setError('No graph data available. Please process text first.');
                    setLoading(false);
                }
            }, []);

            useEffect(() => {
                if (graphData && svgRef.current) {
                    renderGraph();
                }
            }, [graphData]);

            const renderGraph = () => {
                const svg = d3.select(svgRef.current);
                svg.selectAll("*").remove();

                const width = svgRef.current.clientWidth;
                const height = svgRef.current.clientHeight;

                // Create force simulation
                const simulation = d3.forceSimulation(graphData.nodes)
                    .force("link", d3.forceLink(graphData.links).id(d => d.id).distance(100))
                    .force("charge", d3.forceManyBody().strength(-300))
                    .force("center", d3.forceCenter(width / 2, height / 2));

                // Create links
                const link = svg.append("g")
                    .selectAll("line")
                    .data(graphData.links)
                    .enter().append("line")
                    .attr("stroke", GRAPH_CONFIG.colors.linkDefault)
                    .attr("stroke-opacity", GRAPH_CONFIG.links.defaultOpacity)
                    .attr("stroke-width", GRAPH_CONFIG.links.defaultWidth);

                // Create nodes
                const node = svg.append("g")
                    .selectAll("g")
                    .data(graphData.nodes)
                    .enter().append("g")
                    .call(d3.drag()
                        .on("start", dragstarted)
                        .on("drag", dragged)
                        .on("end", dragended));

                // Add circles for nodes
                node.append("circle")
                    .attr("r", GRAPH_CONFIG.nodes.baseRadius)
                    .attr("fill", d => {
                        switch(d.aiCategory) {
                            case 'PERSON': return GRAPH_CONFIG.colors.people;
                            case 'ORG': return GRAPH_CONFIG.colors.events;
                            case 'LOCATION': return GRAPH_CONFIG.colors.places;
                            default: return GRAPH_CONFIG.colors.accent;
                        }
                    })
                    .attr("stroke", GRAPH_CONFIG.colors.border)
                    .attr("stroke-width", GRAPH_CONFIG.nodes.strokeWidth)
                    .on("click", (event, d) => setSelectedNode(d))
                    .on("mouseover", function(event, d) {
                        d3.select(this)
                            .attr("r", GRAPH_CONFIG.nodes.hoverGlowRadius)
                            .attr("stroke-width", GRAPH_CONFIG.nodes.selectedStrokeWidth);
                    })
                    .on("mouseout", function(event, d) {
                        d3.select(this)
                            .attr("r", GRAPH_CONFIG.nodes.baseRadius)
                            .attr("stroke-width", GRAPH_CONFIG.nodes.strokeWidth);
                    });

                // Add labels
                node.append("text")
                    .attr("text-anchor", "middle")
                    .attr("dy", "0.35em")
                    .attr("font-size", GRAPH_CONFIG.nodes.fontSize)
                    .attr("font-weight", GRAPH_CONFIG.nodes.fontWeight)
                    .attr("fill", GRAPH_CONFIG.colors.foreground)
                    .text(d => d.label.length > 15 ? d.label.substring(0, 15) + "..." : d.label);

                // Update positions on simulation tick
                simulation.on("tick", () => {
                    link
                        .attr("x1", d => d.source.x)
                        .attr("y1", d => d.source.y)
                        .attr("x2", d => d.target.x)
                        .attr("y2", d => d.target.y);

                    node
                        .attr("transform", d => `translate(${d.x},${d.y})`);
                });

                function dragstarted(event, d) {
                    if (!event.active) simulation.alphaTarget(0.3).restart();
                    d.fx = d.x;
                    d.fy = d.y;
                }

                function dragged(event, d) {
                    d.fx = event.x;
                    d.fy = event.y;
                }

                function dragended(event, d) {
                    if (!event.active) simulation.alphaTarget(0);
                    d.fx = null;
                    d.fy = null;
                }
            };

            if (loading) {
                return React.createElement('div', { className: 'loading' }, 'Loading graph data...');
            }

            if (error) {
                return React.createElement('div', { className: 'error' },
                    React.createElement('div', null, error),
                    React.createElement('button', {
                        onClick: () => window.close(),
                        className: 'button',
                        style: { marginTop: '1rem' }
                    }, 'Close')
                );
            }

            return React.createElement('div', { className: 'container' },
                React.createElement('div', { className: 'header' },
                    React.createElement('h1', { className: 'title' }, 'Knowledge Graph Visualization'),
                    React.createElement('div', { className: 'status' },
                        `${graphData?.nodes?.length || 0} nodes, ${graphData?.links?.length || 0} links`
                    )
                ),
                React.createElement('div', { className: 'graph-container' },
                    React.createElement('svg', {
                        ref: svgRef,
                        width: '100%',
                        height: '100%'
                    })
                ),
                selectedNode && React.createElement('div', {
                    style: {
                        position: 'absolute',
                        top: '1rem',
                        right: '1rem',
                        background: '#3A3A3A',
                        border: '1px solid #4A4A4A',
                        borderRadius: '0.5rem',
                        padding: '1rem',
                        maxWidth: '300px',
                        color: '#E4E4E4'
                    }
                },
                    React.createElement('div', {
                        style: { display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '0.5rem' }
                    },
                        React.createElement('h3', { style: { margin: 0 } }, selectedNode.label),
                        React.createElement('button', {
                            onClick: () => setSelectedNode(null),
                            style: { background: 'none', border: 'none', color: '#B8B8B8', cursor: 'pointer' }
                        }, '√ó')
                    ),
                    React.createElement('div', { style: { fontSize: '0.875rem', color: '#B8B8B8' } },
                        React.createElement('div', null, `Type: ${selectedNode.type}`),
                        React.createElement('div', null, `Category: ${selectedNode.aiCategory}`),
                        React.createElement('div', null, `Confidence: ${(selectedNode.aiConfidence * 100).toFixed(1)}%`),
                        selectedNode.aiInsights && React.createElement('div', { style: { marginTop: '0.5rem' } },
                            React.createElement('strong', null, 'Insights:'),
                            React.createElement('ul', { style: { margin: '0.25rem 0', paddingLeft: '1rem' } },
                                selectedNode.aiInsights.map((insight, i) =>
                                    React.createElement('li', { key: i }, insight)
                                )
                            )
                        )
                    )
                )
            );
        }

        // Render the app
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(React.createElement(GraphVisualization));
    </script>
</body>
</html>
